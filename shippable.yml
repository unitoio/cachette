language: node_js 

node_js:
  - 12.18.1

services:
  - redis

env:
  global:
    # The path for Xunit to output test reports
    - XUNIT_FILE=shippable/testresults/result.xml
    - LC_ALL=C
    - TEST_REDIS_URL=redis://localhost:6379
    # UNITO_NPM_REGISTRY_TOKEN, used in .npmrc
    - secure: KePo1+ekIM2ILQav5Sex78SHJLvuz+/L/IyO5FHBZ+ohb3WfhwKjrHcXE25TzUM8HrGYvAfLsCf01MBIC7EdiGtzWtndzwh53r8WwsXPp+yabHHKIzlkY6VZ0n2B/PQepOdxfrHhznEkYgD3mSaD+VW1qDG8eOyZN7rCPI1DNTUbwNbTprIemrLFfgziVNkaPw8S4/xInxxbrLifw7pALB19ydhMlHUqPHktftrQvmU9zqDKtTf5JJcTmvx2j4BJQ/kBtRruQasE7Zgjk5qq+L+/ngIMzHk7DcwyOygJzv7Pqg1/irOWHiZdgIc+HyxEO8QYUSkCRKLLrz7AYwHMvA==

branches:
  only:
    - master

build:
  ci:
    - shippable_retry npm ci
    - npm run audit-with-ignore
    - npm run lint
    - npm run test:ci
    - ./scripts/cleanup_tests.sh
  on_success:
    - git remote set-url origin $REPOSITORY_URL
    - git config --get remote.origin.url
    - npm config set '//registry.npmjs.org/:_authToken' "${UNITO_NPM_REGISTRY_TOKEN}"
    - ./scripts/bump_node_package_version.sh
    - ./scripts/publish_public_npm.sh

integrations:
  notifications:
    - integrationName: email
      type: email
      recipients:
        - dev@unito.io
      on_failure: always
      on_success: never
      on_pull_request: never
      on_start: never
